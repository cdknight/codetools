<!DOCTYPE html>
<html lang="en">
<style>
    input,
    button {
        background-color: #222222 !important;
    }
    
    @keyframes backforth {
        0% {
            transform: translateX(-32px);
        }
        50% {
            /* opacity: 0.2; */
        }
        100% {
            transform: translateX(32px);
        }
    }
    
    .goesbackandforth {
        animation: backforth 0.5s infinite alternate ease-in-out;
    }
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tabtitle">Simple Message Test with DB</title>
    <link rel="stylesheet" href="https://hx.cy2.me/basicstyle.css">
</head>

<body id="body" style="margin: 0; display: flex; flex-direction: column; align-items: center;">
    <h1 style="padding-top: 16px; margin: 0;">simple chat test</h1>
    <h2 id="statusText">connecting...</h2>
    <p>online: <span id="onlineText">--</span></p>
    <div id="msgs" style="overflow-y: auto; width: 100%;">
        <!-- <button style="text-align: left;" onclick="getMore(20)">fetch more</button> -->
        <div id="loadingdot" style="background-color: white; width: 16px; height: 16px; border-radius: 8px; margin-left: auto; margin-right: auto;" class="goesbackandforth"></div>
        <p style="text-align: left; margin: 16px; padding-bottom: 60px;" id="messages"></p>
    </div>
    <div style="position: fixed; bottom: 16px; display: flex; align-items: center; justify-content: center; width: 100%; z-index: 5;">
        <input id="messageInput" type="text" placeholder="message" onkeydown="if(event.keyCode == 13) {send();}">
        <button style="margin-left: 8px;" onclick="send()">send</button>
    </div>
</body>
<script>
    var statusText = document.getElementById('statusText')
    var messages = document.getElementById('messages')
    var messageInput = document.getElementById('messageInput')
    var onlineText = document.getElementById('onlineText')
    var msgs = document.getElementById('msgs')
    var earliest;
    var started = false

    var observer = new IntersectionObserver(function(entries) {
        // isIntersecting is true when element and viewport are overlapping
        // isIntersecting is false when element and viewport don't overlap
        if (entries[0].isIntersecting === true) {
            console.log('Element has just become visible in screen');
            getMore(20);
        }
    }, {
        threshold: [0]
    });
    observer.observe(document.getElementById('loadingdot'))

    // Create WebSocket connection.
    if (window.location.hash == "#local") {
        var socket = new WebSocket('ws://localhost:6006');
        document.getElementById('tabtitle').innerHTML = "LOCAL Chat"
    } else var socket = new WebSocket('wss://triangle-wss.secure1.cy2.me');
    // Connection opened
    socket.addEventListener('open', function(event) {
        statusText.innerHTML = "connected"
        console.log('Connected to the WS Server! Fetching old messages.')
            // firstSync(40)
    });

    // Connection closed
    socket.addEventListener('close', function(event) {
        statusText.innerHTML = "connection lost, refresh"
            // mostOfIt.style.filter = "blur(16px)"
            // fatalErrorText.style.display = "block"
            // fatalErrorText.style.opacity = "1"
        console.log('Disconnected from the WS Server!')
    });

    // Listen for messages
    socket.addEventListener('message', function(event) {
        console.log('rx: ', event.data);
        // console.log(event.data)
        result = JSON.parse(event.data)
        switch (result['type']) {
            case 'rxGroupUpdate':
                onlineText.innerHTML = result['viewers']
                break
            case 'queueUpdate':
                queueUpdate(result['updates'])
                console.log(result['updates'])
                firstSync(40)
                started = true
                break
            case 'message':
                messages.innerHTML += "<br>" + result['message']
                msgs.scrollTop = msgs.scrollHeight;
                break
        }
    });
    // Send a msg to the websocket
    function send() {
        socket.send(messageInput.value)
        messageInput.value = ""
        messageInput.focus()
        msgs.scrollTop = msgs.scrollHeight;
    }

    async function firstSync(num) {
        var response = await fetch('https://upstairs.cy2.me/api/group0/updates/last?num=' + num);
        var list = await response.json()
        console.log(list)
        earliest = list[0]['i']
        var already = messages.innerHTML
        messages.innerHTML = ""
        list.forEach(element => {
            messages.innerHTML += "<br>" + element['m']
        });
        messages.innerHTML += already
        msgs.scrollTop = msgs.scrollHeight;
        console.log(earliest)
    }
    async function getMore(num) {
        var response = await fetch('https://upstairs.cy2.me/api/group0/updates/between?end=' + (earliest - 1) + '&start=' + (earliest - num));
        var list = await response.json()
        console.log(list)
        earliest = list[0]['i']
        var oldscrollheight = msgs.scrollHeight;
        var already = messages.innerHTML
        messages.innerHTML = ""
        list.forEach(element => {
            messages.innerHTML += "<br>" + element['m']
        });
        messages.innerHTML += already
        msgs.scrollTop = msgs.scrollHeight - oldscrollheight;
        console.log(earliest)
    }

    function queueUpdate(updates) {
        updates.forEach(element => {
            messages.innerHTML += "<br>" + element['m']
        })
    }
</script>

</html>