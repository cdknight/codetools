{% extends "header.html" %} {% set hideEditorButton = True %} {% set pageName = 'Challenge' %} {% block content %}
<link rel="stylesheet" href="static/editorstyle.css">
<div class="editor-main" onresize="editor.layout()">
    <div id="descriptionSidebar" class="sidebar">
        <h1>Return the string "Hello World"</h1>
        <p>This is a really hard challenge. It is unlikely you will be able to complete it. Use a <code>return</code> statment to return the string.</p>
    </div>
    <div id="monacoContainer">
    </div>
    <div id="argsSidebar" class="sidebar">
        <h1>Run and Test</h1>
        <button id="runbutton" onclick="runcode()" class="fancybutton" style="width: 100%; margin: 0;" onmouseover="this.classList.remove('fancybutton_on', 'fancybutton_error', 'fancybutton_warn'); this.innerHTML='Run Tests'">Run Tests</button>
        <div id="compilerError" style="display: none; flex-direction: column; align-items: center; color: #F88;">
            <p style="display: flex; align-items: center; margin-bottom: 8px;"><i class="material-icons" style="margin-right: 8px;">warning</i> Compiler Error</p>
            <p id="compilerErrorText" class="monofont" style="margin: 0; font-size: 12px; align-self: flex-start;">jsldkfj</p>
        </div>
        <div id="argslist" style="min-height: 24px;">
            <template>
                <div class="arg">
                    <div class="inputdiv">
                        <p>(</p>
                        <input type="text" class="argin monofont" placeholder="args" size="1">
                        <p>)</p>
                        <button class="removeButton hoverfancy"><i class="material-icons">close</i></button>
                    </div>
                    <p class="resultText monofont"><i class="material-icons" style="width: 24px; transform: translateY(25%);">arrow_forwards</i> <span class="resultOutput">No output</span></p>
                </div>
            </template>
        </div>
        <div style="display: flex; justify-content: center; width: 100%;"><button class="hoverfancy" onclick="newarg()" style="padding-right: 12px; margin-top: 12px;"><i class="material-icons">add</i> New Test</button></div>
    </div>
</div>
<div id="uploadStatusDiv" class="uploadStatusDiv uploadStatusColored"><i id="uploadStatusIcon" class="material-icons" style="margin-right: 4px;">cloud_done</i><span id="uploadStatusText">Saved</span></div>
<div class="uploadStatusLine uploadStatusColored">something</div>
<!-- <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js "></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.22.3/min/vs/loader.min.js" integrity="sha512-+8+MX2hyUZxaUfMJT0ew+rPsrTGiTmCg8oksa6uVE/ZlR/g3SJtyozqcqDGkw/W785xYAvcx1LxXPP+ywD0SNw==" crossorigin=" anonymous "></script>
<script>
    var knowCode = "";
    var myContentID = "{{myContentID}}"
    var uploadInstanceCount = 1;
    var uploadFlag = false;
    document.querySelector('body').style.overflow = "hidden";
    var uploadStatusIcon = document.getElementById('uploadStatusIcon')
    var uploadStatusText = document.getElementById('uploadStatusText')
    var runbutton = document.getElementById('runbutton');
    var args;
    var knowArgs;
    var loaded = false;
    require.config({
        paths: {
            'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.22.3/min/vs'
        }
    });
    let editor;
    fetch('/contentget?id=' + myContentID).then(response => response.json()).then(data => require(["vs/editor/editor.main"], function() {
        console.log(data)
        editor = monaco.editor.create(document.getElementById('monacoContainer'), {
            value: data['data']['code'],
            language: 'java',
            theme: 'vs-dark',
            minimap: {
                enabled: false
            },
            automaticLayout: true,
            wordWrap: true,
            fontFamily: "DM Mono, monospace ",
            disableMonospaceOptimizations: true
        });
        knowCode = data['data']['code'];
        const tmp_args = data['data']['args_mutable']
        args = tmp_args
        knowArgs = tmp_args
        console.log(args)
        console.log(knowArgs)
        genArgs(tmp_args)
        setInterval(() => {
            updateArgsLocal()
                // console.log(JSON.stringify(args) != JSON.stringify(knowArgs))
            if (editor.getValue() != knowCode || JSON.stringify(args) != JSON.stringify(knowArgs)) {
                uploadStatusColor("#ffdd00")
                uploadStatusText.innerHTML = "Saving... "
                uploadStatusIcon.innerHTML = "sync "
                uploadFlag = true;
            } else {
                uploadStatusColor("#00ff00")
                uploadStatusText.innerHTML = "Saved "
                uploadStatusIcon.innerHTML = "cloud_done "
            }
        }, 100);
        setInterval(() => {
            if (uploadInstanceCount == 1 && uploadFlag) {
                uploadInstanceCount += 1;
                saveSession().then(() => {
                    uploadInstanceCount = 1;
                })
            }
        }, 5000);
        // document.querySelector('body').addEventListener('resize', editor.layout())
        loaded = true;
    }));

    function uploadStatusColor(color) {
        document.querySelectorAll('.uploadStatusColored').forEach(element => {
            element.style.backgroundColor = color
        })
    }

    async function saveSession() {
        var toUpload = editor.getValue();
        var argsToUplaod = args;
        await fetch('/contentset', {
                method: 'POST', // or 'PUT'
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contentID: myContentID,
                    code: toUpload,
                    args_mutable: argsToUplaod,
                }),
            })
            .then(response => {
                response.json().then(result => console.log(result))
                knowCode = toUpload;
                knowArgs = argsToUplaod;
                uploadFlag = false;
            })
    }

    async function runcode() {
        runbutton.classList.add("fancybutton_half")
        if (uploadFlag) {
            runbutton.innerHTML = "Saving... "
            await saveSession()
        }
        runbutton.innerHTML = "Running... "
        fetch('/runcode?id=' + myContentID)
            .then(response => response.json())
            .then(response => {
                console.log(response);
                if (response.data.run == 'success') {
                    response['data']['outputs'].forEach(result => {
                        let argElement_resultText = document.querySelector('#arg_' + result.id + ' .resultOutput')
                        argElement_resultText.innerHTML = result.output
                    });
                    runbutton.innerHTML = "Tests Complete"
                    document.getElementById("compilerError").style.display = "none"
                        // document.getElementById('resultOutput').innerHTML = response['result']
                    runbutton.classList.add("fancybutton_on")
                    runbutton.classList.remove("fancybutton_half")
                } else if (response.data.run == 'compilerError') {
                    runbutton.innerHTML = "Tests did not run"
                    document.getElementById("compilerErrorText").innerHTML = response.data.error
                    document.getElementById("compilerError").style.display = "flex "
                    runbutton.classList.add("fancybutton_warn")
                    runbutton.classList.remove("fancybutton_half")
                } else if (response.data.run == 'runtimeError') {
                    response['data']['outputs'].forEach(result => {
                        let argElement_resultText = document.querySelector('#arg_' + result.id + ' .resultOutput')
                        argElement_resultText.innerHTML = result.output
                    });
                    runbutton.innerHTML = "Tests Complete"
                    document.getElementById("compilerError").style.display = "none"
                        // document.getElementById("compilerErrorText").innerHTML = response.data.error
                        // document.getElementById("compilerError").style.display = "flex"
                    runbutton.classList.add("fancybutton_warn")
                    runbutton.classList.remove("fancybutton_half")
                }
                if (response.data.run != 'compilerError') args.forEach(element => {
                    if (document.querySelector('#arg_' + element.id + ' input').value == "") {
                        document.querySelector('#arg_' + element.id + ' .resultOutput').innerHTML = "No Output"
                    }
                })
            })
            .catch((error) => {
                console.error('Error:', error);
                runbutton.innerHTML = "Server Error"
                runbutton.classList.add("fancybutton_error")
                runbutton.classList.remove("fancybutton_half")
            });
    }
    const ARG_TEMP = document.querySelector('#argslist template')
    let argslist = document.querySelector('#argslist')

    function newarg() {
        var args_temp = args
        var argid = makeid(10);
        args_temp.push({
            'id': argid,
            'arg': ""
        })
        fetch('/contentset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contentID: myContentID,
                args_mutable: args_temp
            }),
        }).then(() => {
            args = args_temp
            let newarg = ARG_TEMP.cloneNode(true).content
            newarg.querySelector('.arg').id = "arg_" + argid;
            newarg.querySelector('.removeButton').addEventListener('click', function() {
                removearg(argid)
            })
            argslist.appendChild(newarg)
        })

    }

    function removearg(argid) {
        var args_temp = args
        for (var i = 0; i < args_temp.length; i++) {
            if (args_temp[i].id == "arg_" + argid) {
                args_temp.splice(i, 1)
                break;
            }
        };
        fetch('/contentset', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                contentID: myContentID,
                args_mutable: args_temp
            }),
        }).then(() => {
            args = args_temp
            document.getElementById("arg_" + argid).remove()
        })
    }

    function genArgs(toGen) {
        toGen.forEach(element => {
            let newarg = ARG_TEMP.cloneNode(true).content
            let argid = element.id
            newarg.querySelector('.arg').id = "arg_" + argid;
            newarg.querySelector('.removeButton').addEventListener('click', function() {
                removearg(argid)
            })
            newarg.querySelector('input').value = element.arg
            argslist.appendChild(newarg)
        });
    }

    function updateArgsLocal() {
        var args_temp = new Array;
        document.querySelectorAll('#argslist .arg').forEach(element => {
            var id = element.id;
            var arg = document.querySelector('#' + id + ' input').value
            args_temp.push({
                id: id.substring(4),
                arg: arg
            })
        });
        args = args_temp;
    }

    function makeid(length) {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for (var i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }
    window.onbeforeunload = function() {
        if (uploadFlag) return ""
    }
</script>
{% endblock %}